# autodsl_affordance 目录结构与功能详解

## 一、整体架构

autodsl_affordance 目录是预制函数系统的核心实现，采用分层架构设计，包含基础单位定义、链接图分析和预制函数管理三大核心模块。整体架构如下：

```
autodsl_affordance/
├── core/                    # 核心功能模块
│   ├── base_units/          # 基础单位定义
│   ├── linkage_graph/       # 单位链接图系统
│   ├── prefab_system/       # 预制函数系统
├── races/                   # 种族特定单位实现
├── sc2_unit_info/           # 单位信息JSON数据
├── utils/                   # 工具类
├── docs/                     # 文档
```

## 二、核心模块详解

### 1. 基础单位系统 (base_units)

#### 主要作用
定义所有单位的基础结构和标准模板，为整个系统提供统一的单位表示。

#### 核心文件与类
- **unit.py** - 定义 `Unit` 基类，所有单位的根节点
- **standard_unit.py** - 定义 `StandardUnit` 类，提供标准单位模板
- **race_units.py** - 种族相关单位定义
- **mobility_units.py** - 移动性单位定义

#### 关键实现逻辑
- **Unit 类**：提供基础单位属性和方法，包括位置、状态、VLM接口等
- **StandardUnit 类**：扩展 Unit 类，提供标准单位模板，支持从JSON加载数据
- **协同关系生成**：`generate_synergies()` 方法基于单位属性动态生成协同关系
- **预制函数生成**：`generate_prefab_functions()` 方法基于单位属性和协同关系生成预制函数

#### 数据处理流程
1. 初始化单位时从JSON文件加载单位数据
2. 设置默认值并应用自定义参数
3. 增强VLM接口，添加自然语言描述和战术关键词
4. 生成协同关系和链接图边
5. 基于协同关系生成预制函数

#### 系统定位与价值
作为整个预制函数系统的基础，提供统一的单位表示和数据结构，支持后续的链接图分析和预制函数生成。

### 2. 链接图系统 (linkage_graph)

#### 主要作用
构建单位之间的链接图，分析单位间的协同关系，为预制函数提供理论基础。

#### 核心文件与类
- **graph_builder.py** - 链接图构建器
- **node.py** - 节点定义
- **edge.py** - 边定义
- **traversal_strategy.py** - 图遍历策略
- **prefab_function_manager.py** - 预制函数管理器

#### 关键实现逻辑
- **图构建**：基于单位间的协同关系构建链接图
- **边类型**：定义不同类型的边，如支持、组合、依赖等
- **种族特定图**：为不同种族构建特定的链接图
- **预制函数管理**：加载、验证、索引和搜索预制函数

#### 数据处理流程
1. 从单位定义生成协同关系
2. 基于协同关系构建链接图
3. 从链接图生成预制函数
4. 对预制函数进行验证和索引
5. 提供搜索和查询功能

#### 系统定位与价值
作为预制函数系统的核心分析引擎，通过构建链接图分析单位间的协同关系，为预制函数的生成和选择提供理论基础。

### 3. 预制函数系统 (prefab_system)

#### 主要作用
管理和执行预制函数，根据游戏状态选择最优函数组合。

#### 核心文件与类
- **prefab_function_handler.py** - 预制函数处理器
- **prefab_performance_monitor.py** - 预制函数性能监控器
- **prefab_loader.py** - 预制函数加载器
- **prefab_function_manager.py** - 预制函数管理器

#### 关键实现逻辑
- **函数检索**：基于当前游戏状态检索相关预制函数
- **函数评分**：为预制函数评分，考虑协同关系、单位可用性等因素
- **函数选择**：选择最优预制函数组合
- **函数执行**：执行选定的预制函数
- **性能监控**：监控预制函数执行效果，提供反馈

#### 数据处理流程
1. 从游戏状态中提取友方和敌方单位信息
2. 分析游戏状态，检测当前种族
3. 检索与当前单位相关的预制函数
4. 为预制函数评分，考虑多种因素
5. 选择最优预制函数组合
6. 执行选定的预制函数并记录结果
7. 根据执行结果更新函数评分和历史记录

#### 系统定位与价值
作为预制函数系统的执行引擎，负责根据游戏状态选择和执行最优预制函数，直接影响游戏决策质量。

### 4. 种族特定实现 (races)

#### 主要作用
为不同种族提供特定的单位实现和预制函数。

#### 核心文件与目录
- **protoss/** - 神族单位实现
- **terran/** - 人族单位实现
- **zerg/** - 虫族单位实现

#### 关键实现逻辑
- **种族特定单位**：为每个种族实现特定单位
- **单位能力**：实现单位特有能力
- **种族特定战术**：基于种族特点实现特定战术

#### 系统定位与价值
为不同种族提供定制化的单位实现和战术支持，增强系统的适应性和针对性。

### 5. 单位信息数据 (sc2_unit_info)

#### 主要作用
存储单位的详细信息，为单位定义提供数据支持。

#### 核心文件
- **Protoss_*.json** - 神族单位信息
- **Terran_*.json** - 人族单位信息
- **Zerg_*.json** - 虫族单位信息

#### 系统定位与价值
作为单位定义的数据源，提供详细的单位属性和能力信息，支持单位系统的动态加载和配置。

## 三、核心功能模块详解

### 1. PrefabFunctionHandler 类

#### 主要作用
预制函数处理器，封装所有预制函数相关逻辑，包括函数检索、评分、选择、执行和结果反馈。

#### 核心方法
- **retrieve_relevant_functions()** - 基于当前游戏状态检索相关预制函数
- **score_functions()** - 为预制函数评分，考虑多种因素
- **select_optimal_functions()** - 选择最优预制函数组合
- **execute_functions()** - 执行选定的预制函数
- **update_history()** - 更新预制函数执行历史
- **_detect_race()** - 检测当前种族

#### 关键实现逻辑
- **种族检测**：基于单位类型检测当前种族
- **函数评分**：综合考虑协同关系、单位可用性、战术适应性等因素
- **冷却时间管理**：管理预制函数的冷却时间，避免重复执行
- **执行结果反馈**：根据执行结果调整函数评分，实现自学习

#### 系统定位与价值
作为预制函数系统的核心执行引擎，直接影响游戏决策的质量和效果。

### 2. PrefabFunctionManager 类

#### 主要作用
预制函数库管理器，负责函数库的管理、验证和部署。

#### 核心方法
- **load_prefab_functions()** - 从JSON文件加载预制函数库
- **add_prefab_function()** - 添加单个预制函数
- **remove_function()** - 移除指定ID的预制函数
- **search_functions()** - 根据关键字搜索预制函数
- **validate_function_consistency()** - 验证预制函数的一致性
- **get_optimal_functions()** - 获取当前游戏状态下的最优预制函数

#### 关键实现逻辑
- **函数加载**：从JSON文件加载预制函数，支持按种族和地图过滤
- **函数验证**：验证预制函数的一致性和合法性
- **索引构建**：构建多种索引，加速函数检索
- **函数搜索**：支持多条件组合搜索
- **统计信息**：提供预制函数库的统计信息

#### 系统定位与价值
作为预制函数系统的管理中心，负责函数库的维护和检索，为执行引擎提供支持。

### 3. StandardUnit 类

#### 主要作用
提供标准单位模板，支持从JSON加载数据，为所有种族单位提供统一的实现框架。

#### 核心方法
- **_load_unit_data()** - 从JSON文件加载单位数据
- **generate_synergies()** - 基于单位属性动态生成协同关系
- **generate_graph_edges()** - 生成链接图边
- **generate_prefab_functions()** - 基于单位属性和协同关系生成预制函数
- **execute_ability()** - 执行单位能力

#### 关键实现逻辑
- **数据加载**：从JSON文件加载单位数据，支持开发模式
- **协同关系生成**：基于单位类型、属性和克制关系生成协同关系
- **链接图边生成**：基于协同关系生成链接图边
- **预制函数生成**：基于协同关系和能力生成预制函数

#### 系统定位与价值
作为单位系统的核心模板，为所有种族单位提供统一的实现框架，支持从JSON加载数据，简化单位定义和管理。

## 四、模块间交互关系

### 1. 数据流向

1. **基础数据层**：sc2_unit_info 提供单位基础数据
2. **单位定义层**：base_units 基于基础数据定义单位类
3. **分析层**：linkage_graph 基于单位定义构建链接图，分析协同关系
4. **管理层**：prefab_system 基于链接图分析结果管理预制函数
5. **执行层**：PrefabFunctionHandler 执行预制函数，影响游戏决策

### 2. 核心交互流程

1. **初始化流程**：
   - 加载单位数据 → 定义单位类 → 构建链接图 → 加载预制函数

2. **运行时流程**：
   - 接收游戏状态 → 分析游戏状态 → 检索相关预制函数 → 评分 → 选择最优函数 → 执行 → 记录结果 → 更新历史

3. **反馈流程**：
   - 执行结果 → 性能监控 → 调整函数评分 → 优化未来决策

## 五、系统价值与定位

### 1. 在整个预制函数系统中的定位

autodsl_affordance 模块是整个预制函数系统的核心实现，提供了从单位定义、协同关系分析到预制函数管理和执行的完整功能。它是连接游戏状态和决策执行的桥梁，直接影响游戏AI的表现。

### 2. 核心价值

- **统一的单位表示**：提供统一的单位表示和标准模板，简化单位定义和管理
- **智能的协同分析**：基于链接图分析单位间的协同关系，为决策提供理论基础
- **灵活的函数管理**：支持动态加载、验证和搜索预制函数，适应不同游戏场景
- **优化的决策执行**：基于多种因素为预制函数评分，选择最优函数组合
- **自学习能力**：根据执行结果调整函数评分，实现系统的自学习和优化

### 3. 技术创新点

- **分层架构设计**：采用分层架构，模块化程度高，易于扩展和维护
- **动态协同分析**：基于单位属性和克制关系动态生成协同关系，适应不同游戏场景
- **多维度函数评分**：综合考虑多种因素为预制函数评分，提高决策质量
- **自学习机制**：根据执行结果调整函数评分，实现系统的自学习和优化
- **VLM集成**：为单位添加VLM接口，支持自然语言交互和视觉识别

## 六、总结

autodsl_affordance 目录是预制函数系统的核心实现，通过分层架构设计和模块化实现，提供了从单位定义、协同关系分析到预制函数管理和执行的完整功能。它不仅是连接游戏状态和决策执行的桥梁，也是游戏AI智能化的重要支撑。

该系统的设计理念和实现技术对于理解和开发复杂的游戏AI系统具有重要参考价值，特别是在单位协同分析、决策优化和自学习方面的创新，为未来的游戏AI发展提供了新的思路。

通过不断丰富和优化预制函数库，结合VLM技术的应用，autodsl_affordance 系统有望在未来的游戏AI开发中发挥更加重要的作用，为游戏玩家提供更加智能、有趣的游戏体验。